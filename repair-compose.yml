services:
  repair:
    build:
      context: ..
      dockerfile: postgres-data-handler-repair/Dockerfile.repair
    env_file:
      - ./data-handler.env
    environment:
      - NODE_URL=http://backend:17001
      - STATE_CHANGE_DIR=/db/state-changes
      - REPAIR_WORKERS=200
      # API-based gap repair (works for any block height)
      # - USE_STATE_CHANGES=false  # Default: use API
      # - REPAIR_START_HEIGHT=8606270
      # - REPAIR_END_HEIGHT=8606370
      # Or use gap file for batch processing
      - GAP_FILE=state-changes-gaps.txt
    volumes:
      # Use the same bind mount as your backend container
      - /opt/volumes/backend:/db:ro
    restart: "no"
    networks:
      - run_internal

networks:
  run_internal:
    external: true
